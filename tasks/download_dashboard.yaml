---
- name: Download Dashbord | Create local temp grafana dashboard directory
  tempfile:
    state: directory
  register: _tmp_dashboards
  changed_when: false
  check_mode: false
  run_once: true

- name: Download Dashbord | Download grafana dashboard from github to local directory
  get_url:
    url: "{{ item.url_path }}"
    dest: "{{ _tmp_dashboards.path }}/{{ item.name }}"
  with_items: "{{ scale_grafana_bridge_grafana_dashboards }}"
  run_once: true


# As noted in [1] an exported dashboard replaces the exporter's datasource
# name with a representative name, something like 'DS_GRAPHITE'. The name
# is different for each datasource plugin, but always begins with 'DS_'.
# In the rest of the data, the same name is used, but captured in braces,
# for example: '${DS_GRAPHITE}'.
#
# [1] http://docs.grafana.org/reference/export_import/#import-sharing-with-grafana-2-x-or-3-0
#
# The data structure looks (massively abbreviated) something like:
#
#   "name": "DS_GRAPHITE",
#   "datasource": "${DS_GRAPHITE}",
#
# If we import the downloaded dashboard verbatim, it will not automatically
# be connected to the data source like we want it. The Grafana UI expects
# us to do the final connection by hand, which we do not want to do.
# So, in the below task we ensure that we replace instances of this string
# with the data source name we want.
# To make sure that we're not being too greedy with the regex replacement
# of the data source to use for each dashboard that's uploaded, we make the
# regex match very specific by using the following:
#
# 1. Literal boundaries for " on either side of the match.
# 2. Non-capturing optional group matches for the ${} bits which may, or
#    or may not, be there..
# 3. A case-sensitive literal match for DS .
# 4. A one-or-more case-sensitive match for the part that follows the
#    underscore, with only A-Z, 0-9 and - or _ allowed.
#
# This regex can be tested and understood better by looking at the
# matches and non-matches in https://regex101.com/r/f4Gkvg/6

- name: Download and Configure Dashbord | Set the correct data source name in the dashboard files before import
  replace:
    dest: "{{ _tmp_dashboards.path }}/{{ item.name }}"
    regexp: '"(?:\${)?DS_[A-Z0-9_-]+(?:})?"'
    replace: '"{{ item.datasource_name }}"'
  changed_when: false
  with_items: "{{ scale_grafana_bridge_grafana_dashboards }}"
  run_once: true